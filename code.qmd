---
title: "Regression Methods Project"
format: html
editor: visual
---

## Introduction

1.  fr
2.  frf
3.  rf
4.  f
5.  f
6.  f
7.  f
8.  f

## Read the data

Here we explore the data:

The columns of data_agg are:

-   head_head = nbr de fois où la pièce a commencé head et est retombé head

-   tail_head = nbr de fois où la pièce a commencé tail et est retombé head

-   N_start_heads_up = nbr de lancers avec le head en start

-   N_start_tails_up = nbr de lancers avec le tail en start

-   person = personne ayant lancé la pièce

-   coin = type de coin lancée

Après transformation, on a df qui est deux fois plus long et sépare les head head et les tails-tails de data_agg puis coin et personne sont maintenant des variables catégorielles.

df1 regroupe nombre de head sur nombre de lancer pour chaque personne et piece

df2 regroupe nombre de tail sur nombre de lancer pour chaque personne et pièce

```{r}
#| label: "Read the data"
#| echo: false
#| message: false 
#| warning: false
#| error: false

library(ggplot2)
library(dplyr)
library(stringr)
set.seed(12345)

df <- read.csv("data-agg.csv",header=T)
n <- nrow(df)
df1 <- df[,-c(2,4)] # heads to heads
df2 <- df[,-c(1,3)] # tails to heads
df2[,1] <- df2[,2]-df2[,1] # tails to tails 
names(df1) <- names(df2) <- c("y","m","person","coin") 
start <- rep(c("heads","tails"),c(n,n))
df <- rbind(df1,df2)
df$person <- factor(df$person) 
df$coin <- factor(df$coin)
df$start <- factor(start) 

head(df)
head(df1)
head(df2)
```

## Exploratory Data Analysis

### Global analysis

```{r}
#| label: "Global analysis"
#| echo: false
#| message: false 
#| warning: false
#| error: false


### Quick overview of the data
num_persons <- length(unique(df$person))
num_coins <- length(unique(df$coin))

cat("Number of persons:", num_persons, "\n")
cat("Number of coins:", num_coins, "\n")

### Histogram of proportions
df$success <- df$y / df$m
df_heads <- subset(df, start == "heads")
df_tails <- subset(df, start == "tails")

caption_p_general <- str_wrap("Figure 1: Histogram of the success proportions for head starting and tail starting.", width = 85)

p_general <- ggplot(df, aes(x = success)) +
  geom_histogram(bins = 60, fill = "steelblue", color = "white", alpha = 0.8) +
  facet_wrap(~ start, ncol = 2) +
  labs(
    title = "Distribution of same-side proportions",
    x = "Same-side proportion",
    y = "Count",
    caption = caption_p_general
  ) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),   
    plot.caption = element_text(hjust = 0.5),      
    legend.title = element_text(hjust = 0.5),   
    legend.text = element_text(hjust = 0.5)     
  )

# Calcul des statistiques par groupe 'start'
stats <- df %>%
  group_by(start) %>%
  summarize(
    mu = mean(success, na.rm = TRUE),
    sigma = sd(success, na.rm = TRUE),
    .groups = "drop"
  )

p_general + 
  geom_text(
    data = stats,
    aes(
      x = 0.68, 
      y = Inf, 
      label = paste0(
        "atop(hat(mu) == ", round(mu, 3), 
        ", hat(sigma) == ", round(sigma, 3), ")"
      )
    ),
    parse = TRUE,
    hjust = 1.1, vjust = 1.1, 
    size = 3,
    color = "black",
    inherit.aes = FALSE
  )
```

### Analysis by person

```{r}
#| label: "Analysis by person"
#| echo: false
#| message: false 
#| warning: false
#| error: false


### (a) Summary of total flips and success by person
person_summary <- df %>%
  group_by(person) %>%
  summarize(
    total_flips = sum(m),
    mean_success = round(mean(success, na.rm = TRUE), 3),
    .groups = "drop"
  ) %>%
  arrange(mean_success)

print(person_summary)


### (b) Boxplot by person
caption_p_person = str_wrap("Figure 2: Boxplot of the success proportions by person.", width = 85)

p_person <- ggplot(person_summary, aes(x = "", y = mean_success)) +
  geom_boxplot(
    width = 0.1,
    fill = "grey",
    alpha = 0.7,
    outlier.color = "red"
  ) +
  labs(
    title   = "Distribution of Success Proportion across Persons",
    x = "Person",
    y       = "Success Proportion",
    caption = caption_p_person
  ) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),   
    plot.caption = element_text(hjust = 0.5),      
    legend.title = element_text(hjust = 0.5),   
    legend.text = element_text(hjust = 0.5)     
  )

print(p_person)
```

### Analysis by coin

```{r}
#| label: "Analysis by person"
#| echo: false
#| message: false 
#| warning: false
#| error: false


### (a) Summary of total flips and success by person
coin_summary <- df %>%
  group_by(coin) %>%
  summarize(
    total_flips = sum(m),
    mean_success = round(mean(success, na.rm = TRUE), 3),
    .groups = "drop"
  ) %>%
  arrange(mean_success)

print(coin_summary)


### (b) Boxplot by person
caption_p_coin = str_wrap("Figure 3: Boxplot of the success proportions by coin.", width = 85)

p_coin <- ggplot(coin_summary, aes(x = "", y = mean_success)) +
  geom_boxplot(
    width = 0.1,
    fill = "grey",
    alpha = 0.7,
    outlier.color = "red"
  ) +
  labs(
    title   = "Distribution of Success Proportion across Coins",
    x = "Coin",
    y       = "Success Proportion",
    caption = caption_p_coin
  ) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),   
    plot.caption = element_text(hjust = 0.5),      
    legend.title = element_text(hjust = 0.5),   
    legend.text = element_text(hjust = 0.5)     
  )

print(p_coin)
```

### Analysis by combination person-coin

```{r}
#| label: "Analysis by person-coin"
#| echo: false
#| message: false 
#| warning: false
#| error: false

person_coin_summary <- df %>%
  group_by(person, coin) %>%
  summarize(
    total_flips = sum(m),
    mean_success = round(mean(success, na.rm = TRUE), 3),
    .groups = "drop"
  ) %>%
  arrange(mean_success)  

print(person_coin_summary)


### (b) Boxplot by person
caption_p_person_coin = str_wrap("Figure 4: Boxplot of the success proportions by coin and person.", width = 85)

p_person_coin <- ggplot(person_coin_summary, aes(x = "", y = mean_success)) +
  geom_boxplot(
    width = 0.1,
    fill = "grey",
    alpha = 0.7,
    outlier.color = "red"
  ) +
  labs(
    title   = "Distribution of Success Proportion across Coins-Persons",
    x = "Coin-Person",
    y       = "Success Proportion",
    caption = caption_p_person_coin
  ) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),   
    plot.caption = element_text(hjust = 0.5),      
    legend.title = element_text(hjust = 0.5),   
    legend.text = element_text(hjust = 0.5)     
  )

print(p_person_coin)
```

### Summary of analysis person-coin

```{r}
#| label: "Violin Plot"
#| echo: false
#| message: false 
#| warning: false
#| error: false


violin_data <- data.frame(
  category = factor(c(rep("person", nrow(person_summary)),
                      rep("coin", nrow(coin_summary)),
                      rep("person_coin", nrow(person_coin_summary)))),
  mean_success = c(person_summary$mean_success,
                   coin_summary$mean_success,
                   person_coin_summary$mean_success)
)

# Définition de la légende
caption_violin <- str_wrap(
  "Figure 5: Violin plots with boxplots of the distribution of success proportions for persons, coins, and person-coin combinations.",
  width = 85
)

# Création du graphique à violon avec boxplot superposé et facettes
p_violin <- ggplot(violin_data, aes(x = "", y = mean_success)) +
  geom_violin(fill = "steelblue", color = "white", alpha = 0.8) +
  geom_boxplot(width = 0.1, fill = "lightgrey", color = "black", outlier.color = "red") +
  facet_wrap(~ category) +
  labs(
    title = "Distribution of Success Proportions",
    x = "",
    y = "Success Proportion",
    caption = caption_violin
  ) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5),   
    plot.caption = element_text(hjust = 0.5),
    legend.title = element_text(hjust = 0.5),   
    legend.text = element_text(hjust = 0.5),
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold")
  )

print(p_violin)

```

### Temporal effects

pas très concluant

```{r}
#| label: "Temporal analysis"
#| echo: false
#| message: false 
#| warning: false
#| error: false


df_time <- read.csv("df-time-agg.csv", header = TRUE)
df_time <- df_time[, c("same_side", "agg")]
df_time <- df_time %>%
  group_by(agg) %>%
  summarize(mean_same_side = mean(same_side, na.rm = TRUE)) %>%
  ungroup()

acf_result <- acf(df_time$mean_same_side, plot = FALSE)
print(acf_result)

cor_result <- cor(df_time$agg, df_time$mean_same_side, use = "complete.obs")
print(cor_result)

acf(df_time$mean_same_side, main="Autocorrélation de mean_same_side")
```

## GLM Binomial

```{r}
#| label: "GLM Binomial"
#| echo: false
#| message: false 
#| warning: false
#| error: false

# Ajustement du modèle GLM binomial simple
base_glm <- glm(cbind(y, m - y) ~ 1, family = binomial, data = df)

# Résumé du modèle pour voir les résultats
summary(base_glm)




# Calcul du facteur de dispersion
dispersion_ratio <- summary(base_glm)$deviance / summary(base_glm)$df.residual
cat("Dispersion Ratio:", dispersion_ratio, "\n")

# Préparation des données pour le plot des résidus
df_resid <- data.frame(
  fitted = fitted(base_glm),
  pearson_res = residuals(base_glm, type = "pearson")
)

caption_resid <- str_wrap("Figure X: Résidus Pearson vs. Valeurs Prévues du modèle GLM Binomial simple.", width = 85)

p_residuals <- ggplot(df_resid, aes(x = fitted, y = pearson_res)) +
  geom_point(color = "steelblue", alpha = 0.7) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Résidus vs Valeurs Prévues",
    x = "Valeurs Prévues",
    y = "Résidus Pearson",
    caption = caption_resid
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0.5)
  )

print(p_residuals)


df_resid$pearson_res <- residuals(base_glm, type = "pearson")

caption_qq <- str_wrap("Figure Y: Q-Q Plot des Résidus Pearson du modèle GLM Binomial simple.", width = 85)

p_qq <- ggplot(df_resid, aes(sample = pearson_res)) +
  stat_qq(color = "steelblue", alpha = 0.7) +
  stat_qq_line(color = "red", linetype = "dashed") +
  labs(
    title = "Q-Q Plot des Résidus Pearson",
    x = "Quantiles théoriques",
    y = "Quantiles des résidus",
    caption = caption_qq
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 0.5)
  )

print(p_qq)
```
